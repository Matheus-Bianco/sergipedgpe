<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prioriza√ß√£o SAEB 2025 ‚Äî Gest√£o para Aprendizagem</title>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --azul-escuro: #0b5fa5;
            --azul-medio: #1e90ff;
            --azul-claro: #4da6ff;
            --azul-pastel: #f1f9ff;
            --cinza-texto: #666666;
            --branco: #FFFFFF;
            --sombra-suave: 0 4px 15px rgba(11, 95, 165, 0.1);
            --sombra-hover: 0 8px 25px rgba(11, 95, 165, 0.2);
            --border: #e2e8f0;
            --sidebar-width: 320px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Source Sans Pro', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--azul-pastel);
            color: var(--cinza-texto);
            min-height: 100vh;
        }

        /* HEADER */
        .header {
            background: linear-gradient(135deg, var(--azul-escuro) 0%, var(--azul-medio) 100%);
            padding: 1.5rem 0;
            box-shadow: var(--sombra-suave);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo { 
            height: 50px; 
            width: auto;
            filter: brightness(0) invert(1);
        }

        .header-text {
            flex: 1;
            text-align: center;
        }

        .header-title {
            color: var(--branco);
            font-size: 1.6rem;
            font-weight: 700;
            margin: 0;
        }

        .header-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .header-actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn-header {
            background: rgba(255, 255, 255, 0.2);
            color: var(--branco);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0.6rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-header:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* LAYOUT */
        .main-container {
            display: grid;
            grid-template-columns: var(--sidebar-width) 1fr;
            gap: 0;
            max-width: 1600px;
            margin: 0 auto;
        }

        /* SIDEBAR */
        .sidebar {
            background: var(--branco);
            padding: 2rem 1.5rem;
            height: calc(100vh - 90px);
            overflow-y: auto;
            position: sticky;
            top: 90px;
            box-shadow: 2px 0 15px rgba(11, 95, 165, 0.08);
        }

        .sidebar-section {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        .sidebar-title {
            color: var(--azul-escuro);
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .sidebar-icon {
            width: 18px;
            height: 18px;
        }

        .filter-group {
            margin-bottom: 1rem;
        }

        .filter-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--cinza-texto);
            margin-bottom: 0.4rem;
        }

        select, input[type="checkbox"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.85rem;
            font-family: inherit;
        }

        select:focus {
            outline: none;
            border-color: var(--azul-medio);
            box-shadow: 0 0 0 3px rgba(30, 144, 255, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem;
            background: var(--azul-pastel);
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .checkbox-group:hover {
            background: #e3f2fd;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
            cursor: pointer;
        }

        .checkbox-group label {
            font-size: 0.85rem;
            cursor: pointer;
            user-select: none;
        }

        /* Sliders de peso */
        .weight-slider {
            margin-bottom: 1.2rem;
        }

        .weight-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.4rem;
        }

        .weight-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--cinza-texto);
        }

        .weight-value {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--azul-escuro);
            background: var(--azul-pastel);
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--border);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--azul-escuro);
            cursor: pointer;
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: var(--azul-medio);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--azul-escuro);
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        /* Bot√µes da sidebar */
        .btn-primary {
            width: 100%;
            background: linear-gradient(135deg, var(--azul-escuro) 0%, var(--azul-medio) 100%);
            color: var(--branco);
            padding: 0.7rem 1rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(11, 95, 165, 0.3);
        }

        .btn-secondary {
            width: 100%;
            background: var(--branco);
            color: var(--azul-escuro);
            padding: 0.7rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: var(--azul-pastel);
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .info-note {
            font-size: 0.75rem;
            color: #64748b;
            background: #f8fafc;
            padding: 0.6rem;
            border-radius: 6px;
            line-height: 1.4;
            margin-top: 0.5rem;
        }

        /* CONTENT */
        .content {
            padding: 2rem;
            overflow-y: auto;
        }

        /* Status de dados */
        .data-status {
            background: var(--branco);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--azul-pastel);
            color: var(--azul-escuro);
            flex-shrink: 0;
        }

        .status-text {
            flex: 1;
        }

        .status-title {
            font-weight: 600;
            color: var(--azul-escuro);
            margin-bottom: 0.2rem;
        }

        .status-description {
            font-size: 0.85rem;
            color: var(--cinza-texto);
        }

        /* KPIs */
        .kpis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .kpi-card {
            background: var(--branco);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: var(--sombra-suave);
            transition: all 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--sombra-hover);
        }

        .kpi-label {
            font-size: 0.8rem;
            color: var(--cinza-texto);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .kpi-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--azul-escuro);
        }

        /* Cards de conte√∫do */
        .content-card {
            background: var(--branco);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 1.5rem;
            box-shadow: var(--sombra-suave);
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--azul-pastel);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--azul-escuro);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .card-actions select {
            width: auto;
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
        }

        .btn-small {
            background: linear-gradient(135deg, var(--azul-escuro) 0%, var(--azul-medio) 100%);
            color: var(--branco);
            padding: 0.4rem 0.9rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-small:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(11, 95, 165, 0.3);
        }

        /* Scatter plot */
        .scatter-container {
            width: 100%;
            height: 500px;
            position: relative;
            background: #fafbfc;
            border-radius: 8px;
            padding: 1rem;
        }

        .scatter-controls {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: end;
        }

        .axis-selector {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .axis-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--cinza-texto);
        }

        svg {
            width: 100%;
            height: 100%;
        }

        .tooltip {
            position: absolute;
            pointer-events: none;
            background: rgba(13, 27, 42, 0.95);
            color: var(--branco);
            font-size: 0.8rem;
            padding: 0.6rem 0.8rem;
            border-radius: 6px;
            opacity: 0;
            transition: opacity 0.15s;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .legend {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.8rem;
            color: var(--cinza-texto);
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* Tabela */
        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        thead {
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, var(--azul-escuro) 0%, var(--azul-medio) 100%);
            z-index: 10;
        }

        th {
            padding: 0.9rem 0.8rem;
            text-align: left;
            font-weight: 600;
            color: var(--branco);
            white-space: nowrap;
        }

        td {
            padding: 0.8rem;
            border-bottom: 1px solid var(--border);
        }

        tbody tr:hover {
            background: var(--azul-pastel);
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .priority-badge {
            display: inline-block;
            padding: 0.3rem 0.7rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .priority-alta {
            background: #fee2e2;
            color: #991b1b;
        }

        .priority-media {
            background: #fef3c7;
            color: #92400e;
        }

        .priority-baixa {
            background: #d1fae5;
            color: #065f46;
        }

        /* Modal */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(2, 6, 23, 0.6);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 2rem;
        }

        .modal-backdrop.active {
            display: flex;
        }

        .modal {
            background: var(--branco);
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: min(900px, 100%);
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, var(--azul-pastel) 0%, #e3f2fd 100%);
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--azul-escuro);
            margin: 0;
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--cinza-texto);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .btn-close:hover {
            background: rgba(11, 95, 165, 0.1);
            color: var(--azul-escuro);
        }

        .modal-body {
            padding: 2rem;
            overflow-y: auto;
            color: var(--cinza-texto);
            line-height: 1.7;
        }

        .modal-body h4 {
            color: var(--azul-escuro);
            font-size: 1.1rem;
            margin: 1.5rem 0 0.8rem 0;
            font-weight: 600;
        }

        .modal-body h4:first-child {
            margin-top: 0;
        }

        .modal-body ul {
            margin: 0.5rem 0 1rem 1.5rem;
        }

        .modal-body li {
            margin-bottom: 0.5rem;
        }

        .formula-box {
            background: #f8fafc;
            border-left: 3px solid var(--azul-escuro);
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
        }

        .weight-display {
            background: var(--azul-pastel);
            padding: 0.6rem 1rem;
            border-radius: 6px;
            display: inline-block;
            margin-top: 0.5rem;
        }

        .weight-display strong {
            color: var(--azul-escuro);
        }

        .hidden {
            display: none !important;
        }

        /* Responsivo */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 280px 1fr;
            }
            
            :root {
                --sidebar-width: 280px;
            }
        }

        @media (max-width: 992px) {
            .main-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: static;
                height: auto;
                border-bottom: 1px solid var(--border);
            }

            .header-title {
                font-size: 1.3rem;
            }

            .header-subtitle {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .header-left {
                flex-direction: column;
            }

            .kpis-grid {
                grid-template-columns: 1fr;
            }

            .scatter-controls {
                grid-template-columns: 1fr;
            }

            .btn-group {
                grid-template-columns: 1fr;
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .card-actions {
                width: 100%;
                flex-direction: column;
            }

            .card-actions select,
            .btn-small {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <svg class="logo" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 3L1 9l11 6 9-4.91V17h2V9L12 3zM5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82z"/>
                </svg>
            </div>
            <div class="header-text">
                <h1 class="header-title">Prioriza√ß√£o de Escolas ‚Äî SAEB 2025</h1>
                <p class="header-subtitle">Sistema de Score e Ranking para Planejamento Estrat√©gico</p>
            </div>
            <div class="header-actions">
                <button class="btn-header" id="helpBtn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/>
                    </svg>
                    Ajuda
                </button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTAINER -->
    <div class="main-container">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <!-- Status dos dados -->
            <div class="sidebar-section">
                <div class="data-status">
                    <div class="status-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4c-1.48 0-2.85.43-4.01 1.17l1.46 1.46C10.21 6.23 11.08 6 12 6c3.04 0 5.5 2.46 5.5 5.5v.5H19c1.66 0 3 1.34 3 3 0 1.13-.64 2.11-1.56 2.62l1.45 1.45C23.16 18.16 24 16.68 24 15c0-2.64-2.05-4.78-4.65-4.96zM3 5.27l2.75 2.74C2.56 8.15 0 10.77 0 14c0 3.31 2.69 6 6 6h11.73l2 2L21 20.73 4.27 4 3 5.27zM7.73 10l8 8H6c-2.21 0-4-1.79-4-4s1.79-4 4-4h1.73z"/>
                        </svg>
                    </div>
                    <div class="status-text">
                        <div class="status-title">Status dos Dados</div>
                        <div class="status-description" id="dataStatus">Carregando dados...</div>
                    </div>
                </div>
                <div class="info-note">
                    O sistema carrega automaticamente os dados de <code>csv.priorizacao.csv</code> ou permite upload manual via bot√£o "Carregar Dados" no cabe√ßalho.
                </div>
            </div>

            <!-- Filtros -->
            <div class="sidebar-section">
                <h3 class="sidebar-title">
                    <svg class="sidebar-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/>
                    </svg>
                    Filtros de Visualiza√ß√£o
                </h3>

                <div class="filter-group">
                    <label class="filter-label">Diretoria Regional de Educa√ß√£o</label>
                    <select id="f_dre" multiple size="6"></select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Tipo de Ensino</label>
                    <select id="f_tipo" multiple size="4"></select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Categoria</label>
                    <select id="f_cat" multiple size="4"></select>
                </div>

                <div class="filter-group">
                    <label class="filter-label">√Årea Urbana</label>
                    <select id="f_urb" multiple size="3"></select>
                </div>

                <div class="filter-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="f_3ano">
                        <label for="f_3ano">Somente escolas com 3¬∫ ano</label>
                    </div>
                </div>

                <div class="filter-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="f_sem_saeb">
                        <label for="f_sem_saeb">Somente sem SAEB 2023</label>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn-primary" id="applyBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                        </svg>
                        Aplicar
                    </button>
                    <button class="btn-secondary" id="clearBtn">Limpar</button>
                </div>
            </div>

            <!-- Pesos dos Crit√©rios -->
            <div class="sidebar-section">
                <h3 class="sidebar-title">
                    <svg class="sidebar-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M15.67 4H14V2h-4v2H8.33C7.6 4 7 4.6 7 5.33v15.33C7 21.4 7.6 22 8.33 22h7.33c.74 0 1.34-.6 1.34-1.33V5.33C17 4.6 16.4 4 15.67 4zM13 14H9v-2h4v2zm2-4H9V8h6v2z"/>
                        </svg>
                    Pesos dos Crit√©rios
                </h3>

                <div class="weight-slider">
                    <div class="weight-header">
                        <span class="weight-label">Participa√ß√£o</span>
                        <span class="weight-value" id="w_part_val">0.40</span>
                    </div>
                    <input type="range" id="w_part" min="0" max="100" value="40">
                </div>

                <div class="weight-slider">
                    <div class="weight-header">
                        <span class="weight-label">Desempenho</span>
                        <span class="weight-value" id="w_perf_val">0.50</span>
                    </div>
                    <input type="range" id="w_perf" min="0" max="100" value="50">
                </div>

                <div class="weight-slider">
                    <div class="weight-header">
                        <span class="weight-label">Tamanho</span>
                        <span class="weight-value" id="w_size_val">0.10</span>
                    </div>
                    <input type="range" id="w_size" min="0" max="100" value="10">
                </div>

                <button class="btn-primary" id="recalcBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 6v3l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6zm6.76 1.74L17.3 9.2c.44.84.7 1.79.7 2.8 0 3.31-2.69 6-6 6v-3l-4 4 4 4v-3c4.42 0 8-3.58 8-8 0-1.57-.46-3.03-1.24-4.26z"/>
                    </svg>
                    Recalcular Score
                </button>

                <div class="info-note">
                    Os pesos s√£o normalizados automaticamente. Ajuste os sliders e clique em "Recalcular Score" para ver o impacto no ranking.
                </div>
            </div>
        </aside>

        <!-- CONTENT -->
        <main class="content">
            <!-- KPIs -->
            <div class="kpis-grid">
                <div class="kpi-card">
                    <div class="kpi-label">Escolas no filtro</div>
                    <div class="kpi-value" id="k_escolas">‚Äî</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">% com 3¬∫ ano</div>
                    <div class="kpi-value" id="k_3ano">‚Äî</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">M√©dia Part. SAEB 23</div>
                    <div class="kpi-value" id="k_part">‚Äî</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Prioridade Alta</div>
                    <div class="kpi-value" id="k_alta">‚Äî</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Sem SAEB 2023</div>
                    <div class="kpi-value" id="k_sem_saeb">‚Äî</div>
                </div>
            </div>

            <!-- Gr√°fico de Dispers√£o -->
            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                        </svg>
                        Mapa de Prioridade
                    </h2>
                    <div id="legend" class="legend"></div>
                </div>

                <div class="scatter-controls">
                    <div class="axis-selector">
                        <label class="axis-label">Eixo X</label>
                        <select id="x_axis">
                            <option value="part">Participa√ß√£o (prioridade)</option>
                            <option value="perf">Desempenho (prioridade)</option>
                            <option value="size">Tamanho (normalizado)</option>
                            <option value="score" selected>Score de prioridade</option>
                        </select>
                    </div>
                    <div class="axis-selector">
                        <label class="axis-label">Eixo Y</label>
                        <select id="y_axis">
                            <option value="perf" selected>Desempenho (prioridade)</option>
                            <option value="part">Participa√ß√£o (prioridade)</option>
                            <option value="size">Tamanho (normalizado)</option>
                            <option value="score">Score de prioridade</option>
                        </select>
                    </div>
                    <button class="btn-small" id="updatePlotBtn">Atualizar</button>
                </div>

                <div class="scatter-container">
                    <svg id="scatter"></svg>
                    <div class="tooltip" id="tip"></div>
                </div>

                <div class="info-note">
                    <strong>Dica:</strong> Tamanho do ponto = n√∫mero de alunos | Cor do ponto = DRE | Borda do ponto = n√≠vel de prioridade | Linhas tracejadas = medianas
                </div>
            </div>

            <!-- Tabela de Ranking -->
            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
                        </svg>
                        Ranking de Escolas
                    </h2>
                    <div class="card-actions">
                        <label class="filter-label">Mostrar Top</label>
                        <select id="topN">
                            <option value="0">Todas</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                        <button class="btn-small" id="exportBtn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/>
                            </svg>
                            Exportar CSV
                        </button>
                    </div>
                </div>

                <div class="table-wrapper">
                    <table id="tbl">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Escola</th>
                                <th>DRE</th>
                                <th>Tipo</th>
                                <th>Alunos</th>
                                <th>Part. SAEB23</th>
                                <th>Part. Plurall</th>
                                <th>SAEB23 PT</th>
                                <th>SAEB23 MAT</th>
                                <th>SAESE24 PT</th>
                                <th>SAESE24 MAT</th>
                                <th>Rend. PT</th>
                                <th>Rend. MAT</th>
                                <th>Prioridade</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL DE AJUDA -->
    <div class="modal-backdrop" id="helpOverlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Como funciona o Sistema de Prioriza√ß√£o</h3>
                <button class="btn-close" id="helpClose">‚úï</button>
            </div>
            <div class="modal-body">
                <h4>üìä Objetivo do Painel</h4>
                <p>
                    Este sistema calcula um <strong>Score de Prioridade</strong> para cada escola com base em tr√™s dimens√µes: 
                    <strong>Participa√ß√£o</strong>, <strong>Desempenho</strong> e <strong>Tamanho</strong>. 
                    O objetivo √© identificar escolas que necessitam de aten√ß√£o especial para o SAEB 2025.
                </p>

                <h4>üî¢ Como o Score √© Calculado</h4>
                <div class="formula-box">
                    <strong>1. Normaliza√ß√£o (Min-Max):</strong><br>
                    Para cada indicador x no conjunto filtrado:<br>
                    ‚Ä¢ valor_norm = (x - min) / (max - min)<br>
                    ‚Ä¢ Resultado: valores entre 0 e 1<br><br>

                    <strong>2. Invers√£o para Prioridade:</strong><br>
                    ‚Ä¢ Participa√ß√£o e Desempenho: prioridade = 1 - valor_norm<br>
                    ‚Ä¢ (quanto menor, maior a prioridade)<br>
                    ‚Ä¢ Tamanho: mant√©m valor_norm (escolas maiores = maior prioridade)<br><br>

                    <strong>3. Agrega√ß√£o dos Componentes:</strong><br>
                    ‚Ä¢ Participa√ß√£o: m√©dia das m√©tricas de frequ√™ncia dispon√≠veis<br>
                    ‚Ä¢ Desempenho: m√©dia das notas de avalia√ß√µes dispon√≠veis<br>
                    ‚Ä¢ Tamanho: valor normalizado do n√∫mero de alunos<br><br>

                    <strong>4. Score Final:</strong><br>
                    Score = (w_part √ó Part + w_perf √ó Perf + w_size √ó Size) / soma_pesos
                </div>

                <div class="weight-display">
                    <strong>Pesos atuais:</strong> 
                    Participa√ß√£o = <span id="help_w_part">0.40</span> ‚Ä¢ 
                    Desempenho = <span id="help_w_perf">0.50</span> ‚Ä¢ 
                    Tamanho = <span id="help_w_size">0.10</span>
                </div>

                <h4>üìã Indicadores Utilizados</h4>
                <ul>
                    <li><strong>Participa√ß√£o:</strong> Taxa de participa√ß√£o SAEB 2023, Taxa de participa√ß√£o Plurall</li>
                    <li><strong>Desempenho:</strong> SAEB 2023 (PT e MAT), SAESE 2024 (PT e MAT), Rendimento Plurall (PT e MAT)</li>
                    <li><strong>Tamanho:</strong> N√∫mero total de alunos matriculados</li>
                </ul>

                <h4>üéØ Classifica√ß√£o de Prioridade</h4>
                <p>
                    As escolas s√£o classificadas em tr√™s n√≠veis com base nos tercis da distribui√ß√£o do score:
                </p>
                <ul>
                    <li><span class="priority-badge priority-alta">Alta</span> ‚Äî Ter√ßo superior (maior urg√™ncia)</li>
                    <li><span class="priority-badge priority-media">M√©dia</span> ‚Äî Ter√ßo intermedi√°rio</li>
                    <li><span class="priority-badge priority-baixa">Baixa</span> ‚Äî Ter√ßo inferior (menor urg√™ncia)</li>
                </ul>

                <h4>üí° Dicas de Uso</h4>
                <ul>
                    <li>Use os <strong>filtros</strong> para focar em grupos espec√≠ficos de escolas</li>
                    <li>Ajuste os <strong>pesos</strong> para simular diferentes cen√°rios de prioriza√ß√£o</li>
                    <li>No gr√°fico, escolas no <strong>canto superior direito</strong> (alta prioridade em ambos os eixos) merecem aten√ß√£o especial</li>
                    <li>Exporte os dados para an√°lises mais aprofundadas em planilhas</li>
                    <li>A linha vermelha tracejada indica o limiar de 80% de participa√ß√£o (meta)</li>
                </ul>

                <h4>üîÑ Fluxo de Trabalho Recomendado</h4>
                <ol>
                    <li>Selecione os filtros desejados (DRE, tipo de ensino, etc.)</li>
                    <li>Ajuste os pesos conforme sua estrat√©gia de interven√ß√£o</li>
                    <li>Clique em "Aplicar" ou "Recalcular Score"</li>
                    <li>Analise o gr√°fico de dispers√£o para identificar padr√µes</li>
                    <li>Consulte a tabela de ranking para ver detalhes das escolas priorit√°rias</li>
                    <li>Exporte os resultados para compartilhar com a equipe</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- Input oculto para upload manual -->
    <input id="fileInput" type="file" accept=".json,.csv" class="hidden">

    <script>
/* ================== CONFIGURA√á√ÉO ================== */
const DATA_SOURCES = [
    { type: 'csv', url: './csv.priorizacao.csv' },
    { type: 'csv', url: './data/csv.priorizacao.csv' },
    { type: 'json', url: './dados.json' }
];

const COL_MAP = {
    'ID Escola':'id_escola','ID Inep':'id_inep','Escola':'escola','DRE':'dre',
    'Tipo de Ensino':'tipo_ensino','Possui 3o Ano':'possui_3o_ano','Possui 3¬∫ Ano':'possui_3o_ano',
    '√Årea Urbana':'area_urbana','Categoria':'categoria',
    'SAEB 23 Taxa Participa√ß√£o':'saeb23_participacao',
    'SAEB 23 Nota M√©dia PT':'saeb23_pt',
    'SAEB 23 Nota M√©dia Mat':'saeb23_mat',
    'SAESE 24 Profici√™ncia PT':'saese24_pt',
    'SAESE 24 Profici√™ncia MAT':'saese24_mat',
    'Participa√ß√£o Avalia√ß√£o Plurall':'plurall_participacao',
    'Rendimento M√©dio L√≠ngua Portuguesa Plurall':'plurall_rend_pt',
    'Rendimento M√©dio Matem√°tica Plurall':'plurall_rend_mat',
    'N√∫mero de Alunos':'num_alunos'
};

const palette = ["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b",
                 "#e377c2","#7f7f7f","#bcbd22","#17becf","#1b9e77","#d95f02"];

/* ================== UTILIT√ÅRIOS ================== */
const $ = (sel) => document.querySelector(sel);

function fillSelect(id, values) {
    const el = document.getElementById(id);
    el.innerHTML = values.map(v => `<option value="${String(v)}">${String(v)}</option>`).join('');
}

function getSelectedValues(sel) {
    return Array.from(sel.selectedOptions).map(o => o.value);
}

function normalizeArr(values) {
    const arr = values.filter(v => v !== null && !isNaN(v));
    if (!arr.length) return { norm: v => null, min: 0, max: 1 };
    const min = Math.min(...arr), max = Math.max(...arr), span = (max - min) || 1;
    return { norm: v => (v === null || isNaN(v)) ? null : (v - min) / span, min, max };
}

function median(arr) {
    const a = arr.filter(v => v !== null && !isNaN(v)).slice().sort((x, y) => x - y);
    if (!a.length) return null;
    const m = Math.floor(a.length / 2);
    return a.length % 2 ? a[m] : (a[m - 1] + a[m]) / 2;
}

function toNumber(x) {
    if (x === null || x === undefined) return null;
    if (typeof x === 'number') return isFinite(x) ? x : null;
    let s = String(x).trim();
    if (!s) return null;
    const isPct = s.endsWith('%');
    s = s.replace('%', '').replace(/\./g, '').replace(',', '.');
    const v = Number(s);
    return isNaN(v) ? null : v;
}

function truthy3Ano(v) {
    if (v === true || v === 1) return true;
    const s = String(v || '').toLowerCase();
    return ['sim', 'true', '1', 'x'].includes(s);
}

function renameCols(row) {
    const out = {};
    for (const [k, v] of Object.entries(row)) {
        const kk = (k || '').trim();
        const key = COL_MAP[kk] || kk;
        out[key] = v;
    }
    return out;
}

function coerceTypes(r) {
    const o = { ...r };
    ['saeb23_participacao', 'saeb23_pt', 'saeb23_mat', 'saese24_pt', 'saese24_mat',
     'plurall_participacao', 'plurall_rend_pt', 'plurall_rend_mat', 'num_alunos']
        .forEach(k => o[k] = toNumber(o[k]));
    o['possui_3o_ano'] = truthy3Ano(o['possui_3o_ano']);
    return o;
}

function quantile(sorted, q) {
    if (!sorted.length) return null;
    const pos = (sorted.length - 1) * q;
    const base = Math.floor(pos), rest = pos - base;
    return sorted[base] + ((sorted[base + 1] ?? sorted[base]) - sorted[base]) * rest;
}

let SCORE_BANDS = { q33: 0.33, q66: 0.66 };

function calcBands(scored) {
    const arr = scored.map(r => r._score).filter(v => v != null).sort((a, b) => a - b);
    if (!arr.length) { SCORE_BANDS = { q33: 0.33, q66: 0.66 }; return; }
    SCORE_BANDS = { q33: quantile(arr, 1 / 3), q66: quantile(arr, 2 / 3) };
}

function classifyScore(v) {
    if (v == null) return { label: '‚Äî', color: '#64748b' };
    if (v >= SCORE_BANDS.q66) return { label: 'Alta', color: '#e11d48' };
    if (v >= SCORE_BANDS.q33) return { label: 'M√©dia', color: '#f59e0b' };
    return { label: 'Baixa', color: '#10b981' };
}

/* ================== C√ÅLCULO DO SCORE ================== */
function computeScores(rows, weights) {
    const get = (r, k) => (r[k] === null ? null : Number(r[k]));
    const part_cols = ['saeb23_participacao', 'plurall_participacao'];
    const perf_cols = ['saeb23_pt', 'saeb23_mat', 'saese24_pt', 'saese24_mat', 'plurall_rend_pt', 'plurall_rend_mat'];
    const size_cols = ['num_alunos'];
    const normers = {};
    
    for (const c of [...part_cols, ...perf_cols, ...size_cols]) {
        normers[c] = normalizeArr(rows.map(r => get(r, c)));
    }

    return rows.map(r => {
        let part_vals = part_cols.map(c => normers[c].norm(get(r, c))).filter(v => v !== null).map(v => 1 - v);
        const part_score = part_vals.length ? part_vals.reduce((a, b) => a + b, 0) / part_vals.length : null;

        let perf_vals = perf_cols.map(c => normers[c].norm(get(r, c))).filter(v => v !== null).map(v => 1 - v);
        const perf_score = perf_vals.length ? perf_vals.reduce((a, b) => a + b, 0) / perf_vals.length : null;

        const size_val = normers['num_alunos'].norm(get(r, 'num_alunos'));
        const size_score = size_val === null ? null : size_val;

        const comps = [['part', part_score, weights.part], ['perf', perf_score, weights.perf], ['size', size_score, weights.size]];
        const usable = comps.filter(([_, v, w]) => v !== null && w > 0);
        let score = null;
        
        if (usable.length) {
            const wsum = usable.reduce((a, c) => a + c[2], 0) || 1;
            score = usable.reduce((a, [_, v, w]) => a + (w / wsum) * v, 0);
        }
        
        return { ...r, _part: part_score, _perf: perf_score, _size: size_score, _score: score };
    });
}

function weightsNow() {
    const wp = Number($('#w_part').value);
    const wf = Number($('#w_perf').value);
    const ws = Number($('#w_size').value);
    const total = Math.max(wp + wf + ws, 1);
    const W = { part: wp / total, perf: wf / total, size: ws / total };
    $('#w_part_val').textContent = W.part.toFixed(2);
    $('#w_perf_val').textContent = W.perf.toFixed(2);
    $('#w_size_val').textContent = W.size.toFixed(2);
    return W;
}

/* ================== RENDER ================== */
function apply() {
    if (!Array.isArray(window._rowsRaw) || !window._rowsRaw.length) return;

    const sel_dre = getSelectedValues($('#f_dre'));
    const sel_tipo = getSelectedValues($('#f_tipo'));
    const sel_cat = getSelectedValues($('#f_cat'));
    const sel_urb = getSelectedValues($('#f_urb'));
    const only3 = $('#f_3ano').checked;
    const onlyNoSaeb = $('#f_sem_saeb').checked;

    let rows = window._rowsRaw.slice();
    if (sel_dre.length) rows = rows.filter(r => sel_dre.includes(String(r.dre)));
    if (sel_tipo.length) rows = rows.filter(r => sel_tipo.includes(String(r.tipo_ensino)));
    if (sel_cat.length) rows = rows.filter(r => sel_cat.includes(String(r.categoria)));
    if (sel_urb.length) rows = rows.filter(r => sel_urb.includes(String(r.area_urbana)));
    if (only3) rows = rows.filter(r => r.possui_3o_ano === true);
    if (onlyNoSaeb) {
        rows = rows.filter(r =>
            (r.saeb23_pt == null || isNaN(r.saeb23_pt)) &&
            (r.saeb23_mat == null || isNaN(r.saeb23_mat))
        );
    }

    const W = weightsNow();
    const scored = computeScores(rows, W);
    calcBands(scored);
    updateHelpWeights(W);

    renderKPIs(scored);
    renderScatter(scored);
    renderTable(scored);
    renderLegend(scored);
}

function renderKPIs(rows) {
    const n = rows.length;
    $('#k_escolas').textContent = n;

    const has3 = rows.filter(r => r.possui_3o_ano === true).length;
    $('#k_3ano').textContent = n ? ((has3 / n) * 100).toFixed(1) + '%' : '‚Äî';

    const mean = (a) => a.length ? (a.reduce((x, y) => x + y, 0) / a.length) : null;
    const partVals = rows.map(r => r.saeb23_participacao).filter(v => v != null && !isNaN(v)).map(Number);
    $('#k_part').textContent = partVals.length ? (mean(partVals).toFixed(1) + '%') : '‚Äî';

    const alta = rows.filter(r => r._score != null && r._score >= SCORE_BANDS.q66).length;
    $('#k_alta').textContent = alta;

    const semSaeb = rows.filter(r =>
        (r.saeb23_pt == null || isNaN(r.saeb23_pt)) &&
        (r.saeb23_mat == null || isNaN(r.saeb23_mat))
    ).length;
    $('#k_sem_saeb').textContent = semSaeb;
}

function renderLegend(rows) {
    const legend = $('#legend');
    const dres = Array.from(new Set(rows.map(r => r.dre))).filter(Boolean).slice(0, 12);
    legend.innerHTML = dres.map((d, i) => 
        `<div class="legend-item"><span class="legend-dot" style="background:${palette[i % palette.length]}"></span>${d}</div>`
    ).join('');
}

function renderScatter(rows) {
    const svg = $('#scatter');
    const tip = $('#tip');
    const bbox = svg.getBoundingClientRect();
    const W = bbox.width, H = bbox.height;
    
    while (svg.firstChild) svg.removeChild(svg.firstChild);

    const pad = 60, plotW = W - pad * 2, plotH = H - pad * 2;
    const xSel = $('#x_axis').value;
    const ySel = $('#y_axis').value;

    const getV = r => v => (r['_' + v] ?? r['_score']);
    const xAll = rows.map(r => getV(r)(xSel)).filter(v => v != null);
    const yAll = rows.map(r => getV(r)(ySel)).filter(v => v != null);

    if (!xAll.length || !yAll.length) {
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute('x', 20);
        text.setAttribute('y', 30);
        text.setAttribute('fill', '#64748b');
        text.setAttribute('font-size', '14');
        text.textContent = 'Sem dados suficientes para exibir o gr√°fico com os eixos selecionados.';
        svg.appendChild(text);
        return;
    }

    const xMin = Math.min(...xAll), xMax = Math.max(...xAll);
    const yMin = Math.min(...yAll), yMax = Math.max(...yAll);
    const sx = v => pad + ((v - xMin) / ((xMax - xMin) || 1)) * plotW;
    const sy = v => pad + plotH - ((v - yMin) / ((yMax - yMin) || 1)) * plotH;

    // Eixos
    const mkLine = (x1, y1, x2, y2, stroke = '#cbd5e1', dash = null) => {
        const l = document.createElementNS("http://www.w3.org/2000/svg", "line");
        l.setAttribute('x1', x1); l.setAttribute('y1', y1);
        l.setAttribute('x2', x2); l.setAttribute('y2', y2);
        l.setAttribute('stroke', stroke);
        l.setAttribute('stroke-width', '1.5');
        if (dash) l.setAttribute('stroke-dasharray', dash);
        svg.appendChild(l);
    };
    
    mkLine(pad, H - pad, W - pad, H - pad);
    mkLine(pad, pad, pad, H - pad);

    const xMed = median(rows.map(r => getV(r)(xSel)));
    const yMed = median(rows.map(r => getV(r)(ySel)));
    if (xMed !== null) mkLine(sx(xMed), pad, sx(xMed), H - pad, '#94a3b8', '4 4');
    if (yMed !== null) mkLine(pad, sy(yMed), W - pad, sy(yMed), '#94a3b8', '4 4');

    // Labels
    const labels = {
        part: 'Participa√ß√£o (prioridade)',
        perf: 'Desempenho (prioridade)',
        size: 'Tamanho (normalizado)',
        score: 'Score de prioridade'
    };
    
    const t = (text, x, y, anchor = 'middle') => {
        const n = document.createElementNS("http://www.w3.org/2000/svg", "text");
        n.textContent = text;
        n.setAttribute('x', x);
        n.setAttribute('y', y);
        n.setAttribute('fill', '#334155');
        n.setAttribute('font-size', '13');
        n.setAttribute('text-anchor', anchor);
        n.setAttribute('font-weight', '600');
        svg.appendChild(n);
    };
    
    t(labels[xSel] || 'Score', W / 2, H - 15);
    
    const yLabelText = labels[ySel] || 'Score';
    const yLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
    yLabel.textContent = yLabelText;
    yLabel.setAttribute('x', 15);
    yLabel.setAttribute('y', H / 2);
    yLabel.setAttribute('fill', '#334155');
    yLabel.setAttribute('font-size', '13');
    yLabel.setAttribute('text-anchor', 'middle');
    yLabel.setAttribute('font-weight', '600');
    yLabel.setAttribute('transform', `rotate(-90, 15, ${H/2})`);
    svg.appendChild(yLabel);

    // Linha de 80% de participa√ß√£o
    const pVals = rows.map(r => r.saeb23_participacao).filter(v => v != null).map(Number);
    if (pVals.length && (xSel === 'part' || ySel === 'part')) {
        const pMin = Math.min(...pVals), pMax = Math.max(...pVals), span = (pMax - pMin) || 1;
        const prio80 = 1 - ((80 - pMin) / span);
        
        if (xSel === 'part' && prio80 >= xMin && prio80 <= xMax) {
            const lx = sx(prio80);
            mkLine(lx, pad, lx, H - pad, '#ef4444', '6 4');
        }
        if (ySel === 'part' && prio80 >= yMin && prio80 <= yMax) {
            const ly = sy(prio80);
            mkLine(pad, ly, W - pad, ly, '#ef4444', '6 4');
        }
    }

    // Pontos
    const dreList = Array.from(new Set(rows.map(r => String(r.dre))));
    const sVals = rows.map(r => r._size ?? 0);
    const sMin = Math.min(...sVals), sMax = Math.max(...sVals);
    const radiusOf = v => 5 + 14 * ((v - sMin) / ((sMax - sMin) || 1));

    rows.forEach((r) => {
        const xv = getV(r)(xSel), yv = getV(r)(ySel);
        if (xv == null || yv == null) return;

        const cx = sx(xv), cy = sy(yv);
        const fillColor = palette[(dreList.indexOf(String(r.dre)) + palette.length) % palette.length] || '#1f77b4';
        const radius = radiusOf(r._size ?? 0);

        const g = document.createElementNS("http://www.w3.org/2000/svg", "g");

        // Ponto principal
        const dot = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        dot.setAttribute('cx', cx); dot.setAttribute('cy', cy);
        dot.setAttribute('r', radius);
        dot.setAttribute('fill', fillColor);
        dot.setAttribute('fill-opacity', '0.85');
        dot.setAttribute('stroke', 'none');
        g.appendChild(dot);

        // Borda de prioridade
        const cls = classifyScore(r._score);
        const ring = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        ring.setAttribute('cx', cx); ring.setAttribute('cy', cy);
        ring.setAttribute('r', radius + 1);
        ring.setAttribute('fill', 'none');
        ring.setAttribute('stroke', cls.color);
        ring.setAttribute('stroke-width', '2.5');
        g.appendChild(ring);

        // Tooltip
        g.addEventListener('mousemove', (ev) => {
            tip.style.opacity = 1;
            tip.style.left = (ev.offsetX + 12) + 'px';
            tip.style.top = (ev.offsetY + 12) + 'px';
            tip.innerHTML = `
                <strong>${r.escola}</strong><br>
                DRE: ${r.dre ?? '‚Äî'} ‚Ä¢ Alunos: ${r.num_alunos ?? '‚Äî'}<br>
                Score: ${r._score?.toFixed(3) ?? '‚Äî'} (${cls.label})
            `;
        });
        
        g.addEventListener('mouseleave', () => tip.style.opacity = 0);

        svg.appendChild(g);
    });
}

function renderTable(rows) {
    const tbody = document.querySelector('#tbl tbody');
    tbody.innerHTML = '';
    rows.sort((a, b) => (b._score ?? -1) - (a._score ?? -1));
    
    const topN = Number($('#topN').value || 0);
    const show = topN ? rows.slice(0, topN) : rows;
    
    show.forEach((r, idx) => {
        const tr = document.createElement('tr');
        const td = v => {
            const t = document.createElement('td');
            t.textContent = (v ?? '');
            return t;
        };
        
        tr.appendChild(td(idx + 1));
        tr.appendChild(td(r.escola));
        tr.appendChild(td(r.dre));
        tr.appendChild(td(r.tipo_ensino));
        tr.appendChild(td(r.num_alunos));
        tr.appendChild(td(r.saeb23_participacao));
        tr.appendChild(td(r.plurall_participacao));
        tr.appendChild(td(r.saeb23_pt));
        tr.appendChild(td(r.saeb23_mat));
        tr.appendChild(td(r.saese24_pt));
        tr.appendChild(td(r.saese24_mat));
        tr.appendChild(td(r.plurall_rend_pt));
        tr.appendChild(td(r.plurall_rend_mat));
        
        const cl = classifyScore(r._score);
        const badge = document.createElement('td');
        badge.innerHTML = `<span class="priority-badge priority-${cl.label.toLowerCase()}">${cl.label}</span>`;
        tr.appendChild(badge);
        
        tr.appendChild(td(r._score == null ? '' : r._score.toFixed(3)));
        tbody.appendChild(tr);
    });
}

function renderSelects(rows) {
    const uniq = (arr, k) => Array.from(new Set(arr.map(r => r[k]))).filter(Boolean).sort();
    fillSelect('f_dre', uniq(rows, 'dre'));
    fillSelect('f_tipo', uniq(rows, 'tipo_ensino'));
    fillSelect('f_cat', uniq(rows, 'categoria'));
    fillSelect('f_urb', uniq(rows, 'area_urbana'));
}

function exportCSV() {
    const table = $('#tbl');
    let csv = '';
    const rows = table.querySelectorAll('tr');
    
    rows.forEach(row => {
        const cols = row.querySelectorAll('th,td');
        const vals = Array.from(cols).map(c => '"' + (c.textContent || '').replaceAll('"', '""') + '"');
        csv += vals.join(',') + '\n';
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'ranking_escolas_saeb2025.csv';
    a.click();
    URL.revokeObjectURL(url);
}

/* ================== LOADER ================== */
async function tryFetch(url, type) {
    const status = $('#dataStatus');
    try {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
        
        if (type === 'json') {
            return await res.json();
        } else {
            const txt = await res.text();
            const guessSep = (txt.indexOf(';') > txt.indexOf(',')) ? ';' : ',';
            const lines = txt.split(/\r?\n/).filter(l => l.trim().length);
            const head = splitCSVLine(lines[0], guessSep).map(h => h.replace(/^"+|"+$/g, '').trim());
            const rows = lines.slice(1).map(line => {
                const cells = splitCSVLine(line, guessSep);
                const obj = {};
                head.forEach((h, i) => obj[h] = (cells[i] ?? '').replace(/^"+|"+$/g, '').trim());
                return obj;
            });
            return rows;
        }
    } catch (err) {
        status.textContent = `N√£o foi poss√≠vel carregar de ${url.split('/').pop()} (${err.message})`;
        return null;
    }
}

function splitCSVLine(line, sep) {
    const out = []; let cur = ''; let q = false;
    for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') { q = !q; cur += ch; }
        else if (ch === sep && !q) { out.push(cur); cur = ''; }
        else { cur += ch; }
    }
    out.push(cur);
    return out;
}

function ingest(rawRows) {
    const rows = rawRows.map(renameCols).map(coerceTypes);
    window._rowsRaw = rows;
    renderSelects(rows);
    $('#dataStatus').textContent = `‚úì ${rows.length} escolas carregadas com sucesso`;
    apply();
}

/* ================== EVENTOS ================== */
$('#applyBtn').addEventListener('click', apply);
$('#clearBtn').addEventListener('click', () => {
    ['f_dre', 'f_tipo', 'f_cat', 'f_urb'].forEach(id => {
        const el = document.getElementById(id);
        Array.from(el.options).forEach(o => o.selected = false);
    });
    $('#f_3ano').checked = false;
    $('#f_sem_saeb').checked = false;
    apply();
});
$('#recalcBtn').addEventListener('click', apply);
$('#updatePlotBtn').addEventListener('click', apply);
$('#topN').addEventListener('change', apply);
$('#exportBtn').addEventListener('click', exportCSV);

// Sliders de peso
['w_part', 'w_perf', 'w_size'].forEach(id => {
    document.getElementById(id).addEventListener('input', weightsNow);
});

// Modal de ajuda
$('#helpBtn').addEventListener('click', () => {
    updateHelpWeights();
    $('#helpOverlay').classList.add('active');
});

$('#helpClose').addEventListener('click', () => {
    $('#helpOverlay').classList.remove('active');
});

$('#helpOverlay').addEventListener('click', (e) => {
    if (e.target.id === 'helpOverlay') {
        $('#helpOverlay').classList.remove('active');
    }
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        $('#helpOverlay').classList.remove('active');
    }
});

function updateHelpWeights(W) {
    const w = W || weightsNow();
    const pw = (id, val) => {
        const el = document.getElementById(id);
        if (el) el.textContent = (val ?? 0).toFixed(2);
    };
    pw('help_w_part', w.part);
    pw('help_w_perf', w.perf);
    pw('help_w_size', w.size);
}

/* ================== STARTUP ================== */
(async function bootstrap() {
    for (const src of DATA_SOURCES) {
        const raw = await tryFetch(src.url, src.type);
        if (raw && raw.length) {
            ingest(raw);
            return;
        }
    }
    $('#dataStatus').textContent = '‚ö†Ô∏è Nenhum arquivo de dados encontrado. Verifique se csv.priorizacao.csv est√° no mesmo diret√≥rio.';
})();
    </script>
</body>
</html>

